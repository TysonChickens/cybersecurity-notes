# Malware Analysis

{% content-ref url="../general-knowledge/cybersecurity-overview/overview-of-types-of-actors-and-motives/malware-and-an-introduction-to-threat-protection.md" %}
[malware-and-an-introduction-to-threat-protection.md](../general-knowledge/cybersecurity-overview/overview-of-types-of-actors-and-motives/malware-and-an-introduction-to-threat-protection.md)
{% endcontent-ref %}

## Key Malware Behaviors

Malware is software created to harm a computer or an entire network. Threat actors develop malware to achieve specific goals, such as infiltrating networks, breaching sensitive data, or disrupting operational services. There are common behaviors for malware:

* **Network Connections -** Establish either external or internal connections.
  * External allows remote access or downloading staged payloads from a threat actor.
  * Internal allows for lateral movement to extend access to other hosts or applications within the network.
* **Registry key modifications -** Malware typically uses registry keys to establish persistence to discreetly maintain long-term access to a system despite disruptions.
* **File manipulations -** Malware can download (common reasons to establish network connections) or create new files needed for successful execution.

## Dangers of Analyzing Malware Samples

**HANDLING A MALWARE SAMPLE IS DANGEROUS. ALWAYS CONSIDER PRECAUTIONS WHILE ANALYZING.**

Tips when handling live malware:

* Always assume malware samples will infect the device.
* Only run the malware sample in a controlled environment that prevents potential compromise of unwanted assets.
* Always recommended to have a sandbox for a worry-free execution of malware samples.
  * Sandbox is a controlled environment that mimics a user-end working environment. It provides a safe environment to execute malware samples and learn their behavior.

## Static and Dynamic Analysis

**Static Analysis** - Analyzing a malware sample without executing the code. This method focuses on profiling the binary with its readable information, such as its properties, program flow and strings.

* Sometimes this method provides insufficient information and will require a Dynamic Analysis.

**Dynamic Analysis** - Understanding the malware by executing it in a safe environment, such as a Sandbox.

* See the malware live in action, its exact behavior, and how it infects the environment.

### Profile Executable through Static Analysis

Tools used are **Detect It Easy** and **CAPA.**

#### **Detect It Easy**

Right-click sample and execute **Detect It Easy** (DIE). The tool provides information about the file, architecture, headers, packer used, and strings.

Packing malware is a common technique used by malware developers to compress, obfuscate or encrypt the binary file. Contents such as significant strings and headers will not be immediately visible to Static Analysis Tools.

Test this information by following:

* View strings from Detect It Easy, which shows an overwhelming number of strings that are not significant for investigation.
  * Strings are pieces of text inside a binary, often containing information such as IP addresses, URLs, or file names used by the malicious program.
* Run CAPA to show the binary that mostly hides its logic and analysis affected due to a packer.

#### CAPA

CAPA detects capabilities in executable files - Installation of a service, invocation of network connections, registry modifications and such.

* Unpack the binary using UPX and re-analyze the binaries using CAPA.

### Dynamic Malware Analysis

**ProcMon, or Process Monitor**, is a Windows tool that shows real-time registry, file system, and process/thread activity. A feature called **Process Monitor Filter** allows us to filter the results logged by ProcMon. s/et the condition to filter `Process Name - is - NAME_EXE.exe`

ProcMon has a panel that can filter the following:

* Show Registry Activity
* Show File System Activity
* Show Network Activity
* Show Process and Thread Activity
* Show Profiling Events

Malware tends to modify:

* Registry Modification
* File Modification
* Network Connections

#### Registry Modification

Add a filter by finding all Registry Key Creations and Modifications. Remove the operations by right-clicking an entry from the Operation column and choosing Exclude option for:

* RegOpenKey
* RegQueryValue
* RegQueryKey
* RegCloseKey

After filtering, the Registry Key has both **RegCreateKey** and **RegSetValue**. This key is related to a persistence technique called **Registry Run Key Modification** and is commonly used by malware developers to install a backdoor.

#### File Modification

Unclick all filters and choose the second filter - **Show File System Activity** and filters only on **File Write** events. Remove the following operations:

* CreateFile
* CreateFileMapping
* QuerySecurityFile
* QueryNameInformationFile
* QueryBasicInformationFile
* CloseFile
* ReadFile

#### Network Connections

Unselect all filters and choose the third filter - **Show Network Activity**.
